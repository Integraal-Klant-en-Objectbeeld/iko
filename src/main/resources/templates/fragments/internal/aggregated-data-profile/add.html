<!--
 Copyright (C) 2026 Ritense BV, the Netherlands.

 Licensed under EUPL, Version 1.2 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" basis,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 -->

<cds-modal
    id="active-modal"
    prevent-close-on-click-outside="true"
    size="lg"
    open="true"
>
    <cds-modal-header>
        <cds-modal-close-button></cds-modal-close-button>
        <cds-modal-heading>Add Aggregated Data Profile</cds-modal-heading>
    </cds-modal-header>
    <cds-modal-body>
        <cds-form
            id="adp-add-form"
            th:fragment="adp-add-form"
            class="adp-add-form"
        >
            <div class="form-column single-column no-stack">
                <div class="field-block">
                    <cds-text-input
                        name="name"
                        label="Name"
                        required
                        th:attr="invalid=${errors?.getFieldError('name') != null} ? 'true' : null,
                                             invalid-text=${errors?.getFieldError('name')?.defaultMessage},
                                             value=${form?.name}"
                    >
                    </cds-text-input>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <cds-select
                            name="connectorInstanceId"
                            label-text="Select an connector instance"
                            required
                            hx-get="/admin/aggregated-data-profiles/create/endpoints"
                            hx-trigger="cds-select-selected"
                            hx-target="#connector-endpoints"
                            th:attr="invalid=${errors?.getFieldError('connectorInstanceId') != null} ? 'true' : null,
                                             invalid-text=${errors?.getFieldError('connectorInstanceId')?.defaultMessage},
                                             value=${form?.connectorInstanceId != null ? form.connectorInstanceId : (#lists.isEmpty(connectorInstances) ? '' : connectorInstances[0].id)}
                                            "
                        >
                            <cds-select-item
                                th:each="instance : ${connectorInstances}"
                                th:value="${instance.id}"
                            >
                                (<span
                                    th:text="${instance.connector.name + ' ' + instance.connector.version.value}"
                                ></span
                                >)
                                <span th:text="${instance.name}"></span>
                            </cds-select-item>
                        </cds-select>
                    </div>
                    <div class="form-col">
                        <div
                            id="connector-endpoints"
                            th:fragment="connectorEndpoints"
                        >
                            <cds-select
                                label-text="Select an connector endpoint"
                                name="connectorEndpointId"
                                required
                                th:value="${#lists.isEmpty(connectorEndpoints) ? '' : (form?.connectorEndpointId != null ? form.connectorEndpointId : connectorEndpoints[0].id)}"
                                th:attr="invalid=${#lists.isEmpty(connectorEndpoints) or errors?.getFieldError('connectorEndpointId') != null} ? 'true' : null,
                                         invalid-text=${#lists.isEmpty(connectorEndpoints) ? 'No endpoints configured for selected connector' : errors?.getFieldError('connectorEndpointId')?.defaultMessage}"
                            >
                                <cds-select-item
                                    th:each="endpoint : ${connectorEndpoints}"
                                    th:value="${endpoint.id}"
                                >
                                    <span th:text="${endpoint.name}"></span>
                                </cds-select-item>
                            </cds-select>
                        </div>
                    </div>
                </div>
                <div class="field-block">
                    <cds-text-input
                        name="roles"
                        label="Roles"
                        required
                        th:attr="invalid=${errors?.getFieldError('roles') != null} ? 'true' : null,
                                             invalid-text=${errors?.getFieldError('roles')?.defaultMessage},
                                             value=${form?.roles}"
                    >
                    </cds-text-input>
                </div>

                <cds-form-item
                    th:attr="invalid=${errors?.getFieldError('endpointTransform') != null} ? 'true' : null"
                >
                    <label for="endpointTransformCodeAdd">
                        <cds-toggletip
                            alignment="right"
                            alignment-axis-offset="0"
                        >
                            Endpoint Transform
                            <p slot="body-text">
                                Enter a valid JQ expression that returns a
                                Map/object. The resulting key/value pairs are
                                applied as headers on the selected connector
                                endpoint call. Available context: `.idParam`,
                                `.sortParams`, `.filterParams`.
                            </p>
                            <cds-link
                                target="_blank"
                                href="https://jqlang.org/manual/"
                                slot="actions"
                            >
                                JQ Manual
                            </cds-link>
                        </cds-toggletip>
                    </label>
                    <textarea
                        id="endpointTransformCodeAdd"
                        name="endpointTransform"
                        required
                        th:text="'{}'"
                        hidden
                    >
                    </textarea>

                    <!-- Monaco container -->
                    <div
                        id="endpointTransform-editor-add"
                        data-monaco
                        data-language="jq"
                        data-textarea="#endpointTransformCodeAdd"
                        th:data-initial="'{}'"
                        data-theme="lightgray-theme"
                        th:class="${errors?.getFieldError('endpointTransform') != null} ? 'monaco-editor-style monaco-editor-error' : 'monaco-editor-style'"
                    ></div>
                    <div
                        id="endpoint-transform-monaco-error-add"
                        th:class="${errors?.getFieldError('endpointTransform') != null} ? 'monaco-error show' : 'monaco-error'"
                    >
                        <span
                            th:if="${errors?.getFieldError('endpointTransform') != null}"
                            th:text="${errors?.getFieldError('endpointTransform')?.defaultMessage}"
                        ></span>
                    </div>
                </cds-form-item>

                <cds-form-item
                    th:attr="invalid=${errors?.getFieldError('resultTransform') != null} ? 'true' : null"
                >
                    <label for="resultTransformCodeAdd">
                        <cds-toggletip
                            alignment="right"
                            alignment-axis-offset="0"
                        >
                            Result Transform
                            <p slot="body-text">
                                Apply a JQ transform on the result of the adp.
                                Use this to manipulate the result before it is
                                returned as a response to the client.
                            </p>
                            <cds-link
                                target="_blank"
                                href="https://jqlang.org/manual/"
                                slot="actions"
                            >
                                JQ Manual
                            </cds-link>
                        </cds-toggletip>
                    </label>
                    <textarea
                        id="resultTransformCodeAdd"
                        name="resultTransform"
                        required
                        th:text="."
                        hidden
                    >
                    </textarea>

                    <!-- Monaco container -->
                    <div
                        id="result-transform-editor-add"
                        data-monaco
                        data-language="jq"
                        data-textarea="#resultTransformCodeAdd"
                        th:data-initial="."
                        data-theme="lightgray-theme"
                        th:class="${errors?.getFieldError('resultTransform') != null} ? 'monaco-editor-style monaco-editor-error' : 'monaco-editor-style'"
                    ></div>
                    <div
                        id="result-transform-monaco-error-add"
                        th:class="${errors?.getFieldError('resultTransform') != null} ? 'monaco-error show' : 'monaco-error'"
                    >
                        <span
                            th:if="${errors?.getFieldError('resultTransform') != null}"
                            th:text="${errors?.getFieldError('resultTransform')?.defaultMessage}"
                        ></span>
                    </div>
                </cds-form-item>
            </div>
        </cds-form>
    </cds-modal-body>
    <cds-modal-footer>
        <cds-modal-footer-button
            data-modal-close=""
            type="button"
            kind="secondary"
        >
            Cancel
        </cds-modal-footer-button>
        <cds-modal-footer-button
            type="submit"
            hx-post="/admin/aggregated-data-profiles"
            hx-target="#adp-add-form"
            hx-swap="innerHTML"
            hx-include="#adp-add-form [name]"
            hx-on::before-swap="if (event.detail.isError) { event.detail.shouldSwap = true; event.detail.isError = false; }"
            form="adp-add-form"
        >
            Save
        </cds-modal-footer-button>
    </cds-modal-footer>
</cds-modal>
