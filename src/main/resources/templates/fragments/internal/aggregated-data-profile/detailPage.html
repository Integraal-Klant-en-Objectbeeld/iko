<!DOCTYPE html>
<html layout:decorate="~{layout-internal.html}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" lang="en">
<body>
<!-- /* Content of this page will be decorated by the elements of layout-internal.html */ -->
<div layout:fragment="view-panel-content" th:fragment="view-panel-content">
    <div th:replace="~{layout-internal :: breadcrumb (${ {{'aggregated-data-profiles', '/admin/aggregated-data-profiles'}} })}"></div>
    <div class="page-header-container">
        <div th:replace="~{layout-internal :: page-header (title=${aggregatedDataProfile.name})}"></div>
        <div>
            <cds-button kind="secondary">
                Preview
                <svg slot="icon" focusable="false" preserveAspectRatio="xMidYMid meet" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="M26,28H6a2.0027,2.0027,0,0,1-2-2V6A2.0027,2.0027,0,0,1,6,4H16V6H6V26H26V16h2V26A2.0027,2.0027,0,0,1,26,28Z"></path><path d="M20 2L20 4 26.586 4 18 12.586 19.414 14 28 5.414 28 12 30 12 30 2 20 2z"></path><title>Launch</title></svg>
            </cds-button>
        </div>
    </div>

    <div id="panel-all" role="tabpanel" aria-labelledby="tab-all" hidden="">
        Tab Panel 1
    </div>

    <cds-tabs value="general" type="contained">
        <cds-tab id="tab-general" target="panel-general" value="general">General</cds-tab>
        <cds-tab id="tab-relations" target="panel-relations" value="relations">
            Relations
        </cds-tab>
    </cds-tabs>
    <div>
        <div id="panel-general" role="tabpanel" aria-labelledby="tab-general" hidden="">

            <div class="detail-grid">
                <!-- Left column -->
                <div class="detail-column">
                    <cds-tile>
                        <span class="tile-header">Edit profile</span>

<!--PROFILE EDIT FORM-->
                        <div id="profile-edit" th:fragment="profile-edit">
                            <cds-content>
                                <form id="profile-edit-form"
                                      hx-put="/admin/aggregated-data-profiles"
                                      hx-target="#profile-edit"
                                      hx-swap="outerHTML">
                                <cds-form-group id="form-group" name="form-group" class="cds-theme-zone-white" data-carbon-theme="white">
                                    <div class="form-grid">
                                        <div class="form-column">
                                            <cds-stack gap="7">
                                                <input type="hidden" name="id" th:value="${form?.id}"/>
                                                <cds-text-input name="name"
                                                                label="Name"
                                                                th:attr="invalid=${errors?.getFieldError('name') != null} ? 'true' : null,
                                                                         invalid-text=${errors?.getFieldError('name')?.defaultMessage},
                                                                         value=${form?.name}">
                                                </cds-text-input>

                                                <div class="form-row">
                                                    <div class="form-col">
                                                        <cds-select label-text="Select an connector instance" size="md" name="connectorInstanceId"
                                                                    th:value="${form?.connectorInstanceId}"
                                                                    hx-get="/admin/aggregated-data-profiles/create/endpoints" hx-trigger="cds-select-selected"
                                                                    hx-target="#formEndpoints">
                                                            <cds-select-item th:each="instance: ${connectorInstances}" th:value="${instance.id}">
                                                                (<span th:text="${instance.connector.name}"></span>)
                                                                <span th:text="${instance.name}"></span>
                                                            </cds-select-item>
                                                        </cds-select>
                                                    </div>
                                                    <div class="form-col">
                                                        <div id="formEndpoints" th:fragment="connectorEndpoints">
                                                            <cds-select label-text="Select an connector endpoint" size="md" name="connectorEndpointId" th:value="${form?.connectorEndpointId}">
                                                                <cds-select-item th:each="endpoint: ${connectorEndpoints}" th:value="${endpoint.id}">
                                                                    <span th:text="${endpoint.name}"></span>
                                                                </cds-select-item>
                                                            </cds-select>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Add Aggregated Data Profile form -->
                                                <cds-text-input name="role"
                                                                label="Role"
                                                                th:attr="invalid=${errors?.getFieldError('role') != null} ? 'true' : null,
                                                                         invalid-text=${errors?.getFieldError('role')?.defaultMessage},
                                                                         value=${form?.role}">
                                                </cds-text-input>
                                                <cds-text-input id="testId"
                                                                name="testId"
                                                                label="Id for testing the ADP">
                                                </cds-text-input>

                                                <div style="max-width: fit-content;">
                                                    <cds-button
                                                        kind="secondary"
                                                        hx-post="/admin/aggregated-data-profiles/test"
                                                        hx-target="#profile-edit"
                                                        hx-swap="outerHTML"
                                                        hx-include="#form-group *, [id='testId'], [id='name']"
                                                        hx-on::before-request="this.dataset.label=this.textContent; this.textContent='Testing…'; this.setAttribute('disabled','');">
                                                        Test
                                                    </cds-button>
                                                </div>
                                            </cds-stack>
                                        </div>
                                        <div class="form-column">
                                            <cds-form-item>
                                                <label for="transformCode">Transform</label>
                                                <textarea id="transformCode"
                                                          name="transform"
                                                          th:text="${form?.transform}"
                                                          hidden>
                                                </textarea>

                                                <!-- Monaco container -->
                                                <div id="transform-editor"
                                                     data-monaco
                                                     data-language="yaml"
                                                     data-textarea="#transformCode"
                                                     th:data-initial="${form?.transform}"
                                                     data-theme="lightgray-theme"
                                                     class="monaco-editor-style">
                                                </div>
                                            </cds-form-item>
                                            <div id="monaco-error" class="monaco-error"></div>
                                            <span class="sub-text">A valid JQ expression learn at https://jqlang.org/tutorial/</span>


                                            <cds-form-item class="form-actions">
                                                <cds-button
                                                    type="submit"
                                                    data-save-btn
                                                    hx-on:click="document.getElementById('profile-edit-form')?.requestSubmit()"
                                                    hx-on::before-request="const btn = this.querySelector('[data-save-btn]'); if(btn){ btn.dataset.label = btn.textContent; btn.textContent='Saving…'; btn.setAttribute('disabled',''); }"
                                                    hx-on::after-request="const btn = this.querySelector('[data-save-btn]'); if(btn && btn.dataset.label){ btn.textContent = btn.dataset.label; btn.removeAttribute('disabled'); delete btn.dataset.label; }"
                                                >
                                                    Save
                                                </cds-button>
                                            </cds-form-item>
                                        </div>

                                    </div>

                                </cds-form-group>
                                </form>
                            </cds-content>
                        </div>


                    </cds-tile>
                </div>
            </div>

        </div>
        <div id="panel-relations" role="tabpanel" aria-labelledby="tab-relations" hidden="">

            <div class="detail-grid">
                <!-- Left column -->
                <div class="detail-column">
                    <cds-tile class="left-column">
                        <span class="tile-header">Relations</span>
                        <div class="no-content-container" th:if="${relations.isEmpty()}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150" fill="none">
                                <g clip-path="url(#clip0_4554_12419)">
                                    <path d="M75.0004 146.887L20.8691 115.631L75.0004 84.3936L129.113 115.631L75.0004 146.887Z" fill="url(#paint0_linear_4554_12419)"/>
                                    <path d="M74.9996 128.156L20.8496 96.8999L20.8684 34.3687L74.9996 65.6062V128.156Z" fill="url(#paint1_linear_4554_12419)"/>
                                    <path d="M129.15 96.9L75 128.156V65.6063L129.131 34.3688L129.15 96.9Z" fill="url(#paint2_linear_4554_12419)"/>
                                    <path d="M75.0004 65.6061L20.8691 34.3686L75.0004 3.1123L129.132 34.3686L75.0004 65.6061Z" fill="url(#paint3_linear_4554_12419)"/>
                                    <path d="M48.693 50.0062L102.449 18.9749L101.662 18.5249L47.8867 49.5749L48.693 50.0062Z" fill="#C6C6C6"/>
                                    <path d="M75.0004 66.0748L20.8691 34.8186V34.3686L21.2629 34.1436L75.3941 65.3998L75.0004 65.6061V66.0748Z" fill="white"/>
                                    <path d="M40.293 62.4936L24.918 53.6248L24.9367 42.9561L40.293 51.8436V62.4936Z" fill="white"/>
                                </g>
                                <defs>
                                    <linearGradient id="paint0_linear_4554_12419" x1="34.4066" y1="139.069" x2="115.594" y2="92.1935" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#525252" stop-opacity="0.05"/>
                                        <stop offset="1" stop-opacity="0.1"/>
                                    </linearGradient>
                                    <linearGradient id="paint1_linear_4554_12419" x1="28.4246" y1="81.2624" x2="75.5809" y2="81.2624" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#E0E0E0"/>
                                        <stop offset="1" stop-color="#C6C6C6"/>
                                    </linearGradient>
                                    <linearGradient id="paint2_linear_4554_12419" x1="75" y1="81.2625" x2="129.15" y2="81.2625" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#A8A8A8"/>
                                        <stop offset="1" stop-color="#C6C6C6"/>
                                    </linearGradient>
                                    <linearGradient id="paint3_linear_4554_12419" x1="34.4066" y1="57.8061" x2="115.594" y2="10.9311" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#F4F4F4"/>
                                        <stop offset="1" stop-color="#E0E0E0"/>
                                    </linearGradient>
                                    <clipPath id="clip0_4554_12419">
                                        <rect width="150" height="150" fill="white"/>
                                    </clipPath>
                                </defs>
                            </svg>
                            <span class="no-content-text">No relations have been added yet</span>
                        </div>

                        <div id="relations-tree" th:fragment="relations-tree">
                            <cds-tree-view size="">
                                <cds-tree-node
                                    th:each="parent : ${relations}"
                                    th:if="${parent.sourceId == 'Profile root'}"
                                    th:label="|${parent.propertyName} - ${parent.id}|"
                                    th:attr="hx-get=@{'/admin/aggregated-data-profiles/' + ${aggregatedDataProfile.id} + '/relations/edit/' + ${parent.id}},
                                             hx-trigger='mousedown consume',
                                             hx-target='#selected-relation',
                                             hx-swap='innerHTML',
                                             hx-push-url='false'"
                                    class="pointer">
                                    <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" slot="icon" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                                        <rect width="16" height="16" fill="white" style="mix-blend-mode:multiply"/>
                                        <path d="M14 6C14.2652 6 14.5196 5.89464 14.7071 5.70711C14.8946 5.51957 15 5.26522 15 5V2C15 1.73478 14.8946 1.48043 14.7071 1.29289C14.5196 1.10536 14.2652 1 14 1H2C1.73478 1 1.48043 1.10536 1.29289 1.29289C1.10536 1.48043 1 1.73478 1 2V5C1 5.26522 1.10536 5.51957 1.29289 5.70711C1.48043 5.89464 1.73478 6 2 6H7.5V8H4.5C4.23478 8 3.98043 8.10536 3.79289 8.29289C3.60536 8.48043 3.5 8.73478 3.5 9V11H2C1.73478 11 1.48043 11.1054 1.29289 11.2929C1.10536 11.4804 1 11.7348 1 12V14C1 14.2652 1.10536 14.5196 1.29289 14.7071C1.48043 14.8946 1.73478 15 2 15H6C6.26522 15 6.51957 14.8946 6.70711 14.7071C6.89464 14.5196 7 14.2652 7 14V12C7 11.7348 6.89464 11.4804 6.70711 11.2929C6.51957 11.1054 6.26522 11 6 11H4.5V9H11.5V11H10C9.73478 11 9.48043 11.1054 9.29289 11.2929C9.10536 11.4804 9 11.7348 9 12V14C9 14.2652 9.10536 14.5196 9.29289 14.7071C9.48043 14.8946 9.73478 15 10 15H14C14.2652 15 14.5196 14.8946 14.7071 14.7071C14.8946 14.5196 15 14.2652 15 14V12C15 11.7348 14.8946 11.4804 14.7071 11.2929C14.5196 11.1054 14.2652 11 14 11H12.5V9C12.5 8.73478 12.3946 8.48043 12.2071 8.29289C12.0196 8.10536 11.7652 8 11.5 8H8.5V6H14ZM6 14H2V12H6V14ZM14 14H10V12H14V14ZM2 2H14V5H2V2Z" fill="#525252"/>
                                    </svg>
                                    <th:block th:insert="~{::treeNode(parent=${parent})}"></th:block>
                                </cds-tree-node>
                            </cds-tree-view>
                        </div>

                        <th:block th:fragment="treeNode(parent)">
                            <cds-tree-node
                                th:each="child : ${relations}"
                                th:if="${parent != null and child.sourceId == parent.id.toString()}"
                                th:label="|${child.propertyName} - ${child.id}|"
                                th:attr="hx-get=@{'/admin/aggregated-data-profiles/' + ${aggregatedDataProfile.id} + '/relations/edit/' + ${child.id}},
                                         hx-trigger='mousedown consume',
                                         hx-target='#selected-relation',
                                         hx-swap='innerHTML',
                                         hx-push-url='false'"
                                         class="pointer">

                                <th:block th:insert="~{::treeNode(parent=${child})}"></th:block>

                            </cds-tree-node>
                        </th:block>


                        <cds-button
                            kind="secondary"
                            th:if="${relations.isEmpty()}"
                            th:attr="hx-get=@{'/admin/aggregated-data-profiles/' + ${aggregatedDataProfile.id} + '/relations/create'},
                                     hx-target='#selected-relation',
                                     hx-swap='innerHTML',
                                     hx-push-url='false'"
                            size="xl"
                        >
                            Add relation
                            <svg slot="icon" focusable="false" preserveAspectRatio="xMidYMid meet" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="M17 15L17 8 15 8 15 15 8 15 8 17 15 17 15 24 17 24 17 17 24 17 24 15z"></path><title>Add</title></svg>
                        </cds-button>

                    </cds-tile>
                </div>

                <!-- Right column -->
                <div class="detail-column">
                    <cds-tile class="right-tile" >
                        <span class="sub-text">Selected relation</span>
                        <br>
                        <span id="selected-relation-name"></span>
                        <div id="selected-relation"></div>
                    </cds-tile>
                </div>
            </div>

        </div>
    </div>


</div>
</body>
</html>