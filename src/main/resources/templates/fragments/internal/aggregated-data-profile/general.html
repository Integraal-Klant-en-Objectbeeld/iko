<div th:fragment="profile-general">
    <cds-tile>
        <cds-content
                class="cds-theme-zone-white"
                data-carbon-theme="white"
        >
            <form grid
                    id="profile-edit-form"
                    hx-put="/admin/aggregated-data-profiles"
                    hx-swap="beforebegin"
            >
                <div form-row>
                    <div>
                        <cds-stack
                                gap="2rem"
                                use-custom-gap-value="true"
                        >
                            <span class="form-group-title">Basic Properties</span>
                            <input type="hidden" name="id" th:value="${form?.id}"/>
                            <cds-text-input
                                    name="name"
                                    label="Name"
                                    th:attr="
                                        invalid=${errors?.getFieldError('name') != null} ? 'true' : null,
                                        invalid-text=${errors?.getFieldError('name')?.defaultMessage},
                                        value=${form?.name}
                                    "
                            >
                            </cds-text-input>
                            <div form-row>
                                <cds-select
                                        label-text="Select an connector instance"
                                        size="md"
                                        name="connectorInstanceId"
                                        th:value="${form?.connectorInstanceId}"
                                        hx-get="/admin/aggregated-data-profiles/create/endpoints"
                                        hx-trigger="cds-select-selected"
                                        hx-target="#formEndpoints"
                                >
                                    <cds-select-item
                                            th:each="instance: ${connectorInstances}"
                                            th:value="${instance.id}"
                                    >
                                        (<span th:text="${instance.connector.name}"></span>)
                                        <span th:text="${instance.name}"></span>
                                    </cds-select-item>
                                </cds-select>
                                <cds-select
                                        label-text="Select an connector endpoint"
                                        size="md"
                                        name="connectorEndpointId"
                                        th:value="${form?.connectorEndpointId}"
                                >
                                    <cds-select-item
                                            th:each="endpoint: ${connectorEndpoints}"
                                            th:value="${endpoint.id}">
                                        <span th:text="${endpoint.name}"></span>
                                    </cds-select-item>
                                </cds-select>
                            </div>
                            <cds-text-input
                                    name="role"
                                    label="Role"
                                    th:attr="
                                        invalid=${errors?.getFieldError('role') != null} ? 'true' : null,
                                        invalid-text=${errors?.getFieldError('role')?.defaultMessage},
                                        value=${form?.role}"
                            >
                            </cds-text-input>
                        </cds-stack>
                    </div>
                    <div>
                        <cds-stack
                                gap="2rem"
                                use-custom-gap-value="true"
                        >
                            <span class="form-group-title">Transforms</span>
                            <cds-form-item>
                                <label for="endpointTransformEditor">
                                    <cds-toggletip alignment="right" alignment-axis-offset="0">
                                        Endpoint mapping transform
                                        <p slot="body-text">
                                            Apply a transform on the outgoing endpoint exchange.
                                            This can be used to map query parameters from the ADP input to the endpoint.
                                        </p>
                                        <cds-link
                                                href="https://jqlang.org/tutorial/"
                                                slot="actions"
                                        >
                                            JQ Tutorial
                                        </cds-link>
                                        <cds-link
                                                href="https://jqlang.org/manual/"
                                                slot="actions"
                                        >
                                            JQ Manual
                                        </cds-link>
                                    </cds-toggletip>
                                </label>
                                <textarea id="endpointTransformCode"
                                          name="endpointTransform"
                                          th:text="${form?.endpointTransform}"
                                          hidden
                                >
                                </textarea>
                                <!-- Monaco container -->
                                <div id="endpointTransformEditor"
                                     data-monaco
                                     data-language="yaml"
                                     data-textarea="#endpointTransformCode"
                                     th:data-initial="${form?.endpointTransform}"
                                     data-theme="lightgray-theme"
                                     class="monaco-editor-style"
                                     data-size="sm"
                                >
                                </div>
                            </cds-form-item>
                            <cds-form-item>
                                <label for="transformCodeEditor">
                                    <cds-toggletip alignment="right" alignment-axis-offset="0">
                                        ADP Transform
                                        <p slot="body-text">
                                            Apply a JQ transform on the result of the adp.
                                            Use this to manipulate the result before it is returned as a response to the
                                            client.
                                        </p>
                                        <cds-link
                                                href="https://jqlang.org/tutorial/"
                                                slot="actions"
                                        >
                                            JQ Tutorial
                                        </cds-link>
                                        <cds-link
                                                href="https://jqlang.org/manual/"
                                                slot="actions"
                                        >
                                            JQ Manual
                                        </cds-link>
                                    </cds-toggletip>
                                </label> <textarea
                                    id="transformCode"
                                    name="transform"
                                    th:text="${form?.transform}"
                                    hidden
                            >
                                    </textarea>

                                <!-- Monaco container -->
                                <div id="transformCodeEditor"
                                     data-monaco
                                     data-language="yaml"
                                     data-textarea="#transformCode"
                                     th:data-initial="${form?.transform}"
                                     data-theme="lightgray-theme"
                                     class="monaco-editor-style"
                                     data-size="lg"
                                >
                                </div>
                                <div id="monaco-error" class="monaco-error"></div>
                            </cds-form-item>
                        </cds-stack>
                    </div>
                </div>
            </form>
            <div class="form-actions">
                <cds-button
                        type="submit"
                        data-save-btn
                        hx-on:click="document.getElementById('profile-edit-form')?.requestSubmit()"
                        hx-on::before-request="const btn = this.querySelector('[data-save-btn]'); if(btn){ btn.dataset.label = btn.textContent; btn.textContent='Savingâ€¦'; btn.setAttribute('disabled',''); }"
                        hx-on::after-request="const btn = this.querySelector('[data-save-btn]'); if(btn && btn.dataset.label){ btn.textContent = btn.dataset.label; btn.removeAttribute('disabled'); delete btn.dataset.label; }"
                >
                    Save
                </cds-button>
                </cds-stack>
            </div>
        </cds-content>
    </cds-tile>
</div>