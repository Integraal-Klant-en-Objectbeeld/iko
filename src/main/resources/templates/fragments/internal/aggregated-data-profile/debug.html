<div id="profile-debug" th:fragment="profile-debug">
    <cds-tile>
        <cds-tabs value="result" type="contained">
            <cds-tab id="tab-result" target="panel-result" value="result">
                Result
            </cds-tab>
            <cds-tab id="tab-trace" target="panel-trace" value="trace">
                Trace
            </cds-tab>
            <cds-tab id="tab-error" target="panel-error" value="error"
                     th:attr="disabled=${exception == null ? 'true' : null}">
                Error
            </cds-tab>
        </cds-tabs>
        <div style="margin-top: 1rem;">
            <div id="panel-result" role="tabpanel" aria-labelledby="tab-result" hidden="">
                <cds-form-group id="form-group-test" name="form-group" class="cds-theme-zone-white" data-carbon-theme="white">
                    <cds-stack gap="7">

                        <input type="hidden" id="name" name="name" th:value="${form.name}">
                        <input type="hidden" id="transform" name="transform" value=".">

                        <cds-text-input id="testId"
                                        name="testId"
                                        label="Id for testing the ADP"
                                        th:value="${testId}"
                        >
                        </cds-text-input>

                        <cds-form-item>
                            <cds-textarea id="testResult"
                                          name="Test result"
                                          style="width: 100%;"
                                          label="Result"
                                          rows="8"
                                          th:value="${testResult}">
                            </cds-textarea>

                            <cds-button
                                kind="primary"
                                hx-post="/admin/aggregated-data-profiles/debug"
                                hx-target="#profile-debug"
                                hx-swap="outerHTML"
                                hx-include="[id='testId'], [id='transform'], [id='name']"
                                hx-on::before-request="this.dataset.label=this.textContent; this.textContent='Testingâ€¦'; this.setAttribute('disabled','');">
                                Get results
                            </cds-button>
                        </cds-form-item>

                        <cds-form-item>
                            <cds-textarea id="query"
                                          name="query"
                                          style="width: 100%;"
                                          label="Transform"
                                          rows="5"
                                          th:attr="value=${form.transform}">
                            </cds-textarea>

                            <cds-button id="run" kind="primary">Apply transform</cds-button>
                        </cds-form-item>

                        <cds-textarea id="output"
                                      name="output"
                                      style="width: 100%;"
                                      label="Output"
                                      rows="8">
                        </cds-textarea>
                        <div id="error" style="color:#c00;"></div>

                        <script type="application/javascript">
                            // Helper: pretty-print anything
                            function pretty(v) {
                                try { return typeof v === 'string' ? v : JSON.stringify(v, null, 2); }
                                catch { return String(v); }
                            }
                            document.getElementById('run').addEventListener('click', async () => {
                                let outEl = document.getElementById('output');
                                let errEl = document.getElementById('error');
                                errEl.textContent = '';
                                outEl.textContent = 'Running...';

                                let data;
                                let jsonEl;
                                try {
                                    jsonEl = document.getElementById('testResult').value;
                                    data = JSON.parse(jsonEl);
                                } catch (e) {
                                    errEl.textContent = 'Invalid JSON: ' + e.message;
                                    outEl.value = '';
                                    return;
                                }
                                try {
                                    let program = document.getElementById('query').value;
                                    let result = (await jq).json(data, program);
                                    outEl.value = Array.isArray(result) && result.length > 1
                                        ? pretty(result)
                                        : pretty(Array.isArray(result) ? result[0] : result);
                                } catch (e) {
                                    errEl.textContent = 'jq error: ' + (e?.message || e);
                                    outEl.textContent = '';
                                }
                            });
                        </script>
                    </cds-stack>
                </cds-form-group>
            </div>
            <div id="panel-trace" role="tabpanel" aria-labelledby="tab-trace" hidden="">
                <cds-table>
                    <cds-table-head>
                        <cds-table-header-row>
                            <cds-table-header-cell>ID</cds-table-header-cell>
                            <cds-table-header-cell>Timestamp</cds-table-header-cell>
                            <cds-table-header-cell>Route</cds-table-header-cell>
                            <cds-table-header-cell>Location</cds-table-header-cell>
                            <cds-table-header-cell>Elapsed</cds-table-header-cell>
                            <cds-table-header-cell>Status</cds-table-header-cell>
                        </cds-table-header-row>
                    </cds-table-head>
                    <cds-table-body>
                        <cds-table-row th:each="trace : ${traces}">
                            <cds-table-cell th:text="${trace.id}"></cds-table-cell>
                            <cds-table-cell th:text="${trace.timestamp}"></cds-table-cell>
                            <cds-table-cell th:text="${trace.route}"></cds-table-cell>
                            <cds-table-cell th:text="${trace.location}"></cds-table-cell>
                            <cds-table-cell th:text="${trace.elapsed}"></cds-table-cell>
                            <cds-table-cell th:text="${trace.status}"
                                            th:style="${trace.status == 'OK' ? 'color: var(--cds-support-success);' :
                                            trace.status == 'FAILED' ? 'color: var(--cds-support-error);' :
                                            trace.status == 'IN_PROGRESS' ? 'color: var(--cds-support-info);' : ''}">
                            </cds-table-cell>
                        </cds-table-row>
                    </cds-table-body>
                </cds-table>
            </div>
            <div id="panel-error" role="tabpanel" aria-labelledby="tab-error" hidden="">
                <h4>Stacktrace:</h4>
                <div id="kotlin-stacktrace-viewer"
                     data-monaco
                     data-language="json"
                     data-readonly=true
                     data-theme="lightgray-theme"
                     th:data-initial="${exception != null ? exception.getStacktrace() : ''}"
                     class="monaco-editor-style-full-height">
                </div>
            </div>
        </div>
    </cds-tile>
</div>